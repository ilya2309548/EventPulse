services:
  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --api.insecure=true
    ports:
      - "80:80"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  app:
    build:
      context: .
      dockerfile: cmd/app/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Path(`/work`)"
      - "traefik.http.routers.app.entrypoints=web"
      - "traefik.http.services.app.loadbalancer.server.port=8080"
      - "service=app"
    environment:
      - SERVICE=app
      - APP_GOMAXPROCS=1
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 2s
      retries: 3
    cpus: "1.0"
  # Remove CPU cap to allow higher peaks; control load via /work?ms=...&workers=... and APP_GOMAXPROCS

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8082:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro

  prometheus:
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro

  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

  webhook-debug:
    build:
      context: .
      dockerfile: cmd/webhook-debug/Dockerfile
    ports:
      - "8080:8080"
    # Keep for debugging; not used as receiver now
  ingest:
    build:
      context: .
      dockerfile: cmd/ingest/Dockerfile
    environment:
      - INGEST_DB_DSN=postgres://ingest:ingest@ingest-db:5432/ingest?sslmode=disable
    depends_on:
      ingest-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 2s
      retries: 3

  loadgen:
    build:
      context: .
      dockerfile: cmd/loadgen/Dockerfile
    depends_on:
      - traefik
      - app
    environment:
      - TARGET_URL=http://traefik/work?ms=800&workers=4
      - RATE=300
      - CONCURRENCY=100

  ingest-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=ingest
      - POSTGRES_USER=ingest
      - POSTGRES_PASSWORD=ingest
    volumes:
      - ingest-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ingest"]
      interval: 10s
      timeout: 3s
      retries: 5

  rules-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=rules
      - POSTGRES_USER=rules
      - POSTGRES_PASSWORD=rules
    volumes:
      - rules-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rules"]
      interval: 10s
      timeout: 3s
      retries: 5

  action-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=action
      - POSTGRES_USER=action
      - POSTGRES_PASSWORD=action
    volumes:
      - action-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U action"]
      interval: 10s
      timeout: 3s
      retries: 5

  incident-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=incident
      - POSTGRES_USER=incident
      - POSTGRES_PASSWORD=incident
    volumes:
      - incident-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U incident"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  ingest-db-data:
  rules-db-data:
  action-db-data:
  incident-db-data:
