services:
  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --api.insecure=true
    ports:
      - "80:80"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  app:
    build:
      context: .
      dockerfile: cmd/app/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Path(`/work`)"
      - "traefik.http.routers.app.entrypoints=web"
      - "traefik.http.services.app.loadbalancer.server.port=8080"
      - "service=app"
    environment:
      - SERVICE=app
      - APP_GOMAXPROCS=1
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 2s
      retries: 3
    cpus: "1.0"
  # Remove CPU cap to allow higher peaks; control load via /work?ms=...&workers=... and APP_GOMAXPROCS

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8082:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro

  prometheus:
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro

  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro

  webhook-debug:
    build:
      context: .
      dockerfile: cmd/webhook-debug/Dockerfile
    ports:
      - "8080:8080"

  loadgen:
    build:
      context: .
      dockerfile: cmd/loadgen/Dockerfile
    depends_on:
      - traefik
      - app
    environment:
      - TARGET_URL=http://traefik/work?ms=800&workers=4
      - RATE=300
      - CONCURRENCY=100
